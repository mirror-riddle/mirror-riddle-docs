---
id: effective-loop
title: 高效循环
---

在编程领域，循环是一个司空见惯的概念。一个循环语句由循环条件和循环体两部分组成。一旦循环启动，在循环条件得到满足或主动终止循环之前，循环体会反复执行。由于这一特性，循环代码执行效率对程序的影响会成倍放大。要想写出高效的循环代码，可以从以下几方面入手。

### 提取无需重复计算的代码到循环前

提取要执行多次但是结果不变的计算代码，将它们移动到循环的前面。最常见的低效率循环就是在测试条件中计算边界值，而边界值实际上不会随着循环的进行而改变。

```cpp
/*
 * 低效循环: 每次循环都计算边界值strlen(s), 计算 ('A' - 'a');
 */
int lower1(char s[]) {
  for (int i = 0; i < strlen(s); i++) {
    if (s[i] >= 'A' && s[i] <= 'Z') {
      s[i] += ('a' - 'A');
    }
  }
}

/*
 * 优化循环：将重复计算提取到循环前面
 */
int lower2(char s[]) {
  char gap = 'a' - 'A';
  int length = strlen(s);
  for (int i = 0; i < length; i++) {
    if (s[i] >= 'A' && s[i] <= 'Z') {
      s[i] += gap;
    }
  }
}
```

在 JavaScript 中，以数组、字符串对象的长度属性作为边界值，虽然不用每次都计算该长度，但是在循环中，获取对象的属性值和获取变量值相比，后者效率高很多，所以还是在循环前用变量存储长度值最佳。

### 合并算术操作

将多个算术操作合为一个，比如多个加法合并为一个乘法，可以减少总体操作数量，进而提升循环效率。

```javascript
let sum = 0;
for (let i = 0; i < 100; i++) {
  sum += i + (i + 1) + (i + 2) + (i + 3) + (i + 4); // 8个加法，低效
  sum += 5 * (i + 2); // 合并为1个乘法1个加法，效率更高
}
```

### 消除不必要的引用

因为对内存进行读写比对寄存器进行读写要慢得多，所以在循环内部将对内存读写变换为寄存器读写就能大大提高循环效率。在代码中操作指针(引用)，势必要通过存储在寄存器中的指针去内存中读写相应数据，效率不高。如果我们用变量来替代引用（循环过程中变量的值直接保存在寄存器上，对它进行读写速度非常快），循环结束后再把指针指向的数据设置为变量值，效率就大大提升了。

```javascript
const count = 10000;

function func1() {
  console.time('func1');
  const obj = {
    sum: 0,
  };
  for (let i = 0; i < count; i++) {
    obj.sum = obj.sum + i;
  }
  console.timeEnd('func1');
}

function func2() {
  console.time('func2');
  const obj = {
    sum: 0,
  };
  let sum = 0;
  for (let i = 0; i < 1000; i++) {
    sum = sum + i;
  }
  obj.sum = sum;
  console.timeEnd('func2');
}

func1(); // func1: 0.461ms
func2(); // func2: 0.033ms
```

### 循环展开

循环展开是一种程序变换技巧，通过增加每次迭代计算的元素的数量，减少循环的迭代次数，使总体执行效率变高。一方面它减少了不直接有助于程序结果的操作的数量，例如循环索引计算和条件分支。其次，它提供了一些方法，可以进一步变化代码，减少整个计算过程中关键路径上的操作数量。

```javascript
let i;
let sum = 0;
// 展开两次
for (i = 0; i < n - 1; i += 2) {
  sum += 2 * i + 1;
}
// 处理展开时被忽略掉的元素
for (; i < n; i++) {
  sum += i;
}
```
